import{newFruitSound,fruitSliced,bombSlicedSound}from"./game.js";import{hand}from"./posenet.js";import{fruitsModels,commonFruitProperties,trailOptions,scoreDivContent}from"./constants.js";import{generateRandomPosition,losePoint,endGame}from"./game.js";var camera,renderer,randomXPosition,randomYPosition,cameraZPosition;const fruitsObjects=[],fruits=[];var fruitModel;let lastTrailUpdateTime=performance.now();const gameOver=!1;let score=0;var trailTarget,trailMaterial,trail,trailHeadGeometry,baseTrailMaterial,texturedTrailMaterial,circlePoints;export var frameLoop;export var scene;export const initScene=()=>{scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,1e3),cameraZPosition=300,camera.position.set(0,0,cameraZPosition),scene.add(camera)};export const initRenderer=()=>{renderer=new THREE.WebGLRenderer({alpha:!0}),renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight);let e=document.getElementsByClassName("game")[0];e.appendChild(renderer.domElement)};export const initLights=()=>{let e=new THREE.AmbientLight(new THREE.Color("rgb(255,255,255)"));e.position.set(10,0,50),scene.add(e);let t=new THREE.PointLight(16777215,2,1e3,1);t.position.set(0,40,0),scene.add(t)};export const loadFruitsModels=()=>fruitsModels.map(e=>{var t=new THREE.MTLLoader;return t.setPath("../assets/"),t.load(`${e.material}.mtl`,function(t){t.preload();var i=new THREE.OBJLoader;i.setMaterials(t),i.setPath("../assets/"),i.load(`${e.model}.obj`,function(t){t.traverse(function(t){if(t instanceof THREE.Mesh){var i=new THREE.Mesh(t.geometry,t.material);fruitModel=i,fruitModel.name=e.name,fruits.push(fruitModel)}}),fruits.length===fruitsModels.length&&generateFruits(1)})}),fruits});export const generateFruits=e=>{for(var t=0;t<e;t++){const e=fruits[generateRandomPosition(0,2)];let t=e.clone();switch(t.name){case"apple":randomXPosition=generateRandomPosition(-120*camera.aspect,120*camera.aspect),randomYPosition=generateRandomPosition(-290,-190),t.position.set(randomXPosition,randomYPosition,100),t.thresholdBottomY=randomYPosition;break;case"banana":randomXPosition=generateRandomPosition(-200*camera.aspect,200*camera.aspect),randomYPosition=generateRandomPosition(-370,-270),t.position.set(randomXPosition,randomYPosition,0),t.thresholdBottomY=randomYPosition;break;case"bomb":randomXPosition=generateRandomPosition(-110*camera.aspect,110*camera.aspect),randomYPosition=generateRandomPosition(-290,-190),t.position.set(randomXPosition,randomYPosition,100),t.scale.set(20,20,20),t.thresholdBottomY=randomYPosition}t.index=fruitsObjects.length,t.thresholdTopY=commonFruitProperties[t.name].thresholdTopY,t.soundPlayed=commonFruitProperties.soundPlayed,t.direction=commonFruitProperties.direction,t.hit=commonFruitProperties.hit,t.speed=commonFruitProperties.speed,fruitsObjects.push(t),scene.add(t),render()}};export const render=()=>renderer&&renderer.render(scene,camera);export const initSceneGeometry=e=>{initTrailHeadGeometries(),initTrailTarget(),e&&e()};const initTrailHeadGeometries=()=>{circlePoints=[];for(var e=2*Math.PI,t=0,i=10,r=e/32,a=0;a<=e+r;a+=r){var o=new THREE.Vector3;o.set(Math.cos(a)*i,Math.sin(a)*i,0),circlePoints[t]=o,t++}},initTrailTarget=()=>{var e=new THREE.CircleGeometry(5,32),t=new THREE.MeshBasicMaterial({color:16777215});trailTarget=new THREE.Mesh(e,t),trailTarget.position.set(0,-500,0),trailTarget.scale.multiplyScalar(1),trailTarget.receiveShadow=!1,scene.add(trailTarget)};export const initTrailRenderers=e=>{trail=new THREE.TrailRenderer(scene,!1),baseTrailMaterial=THREE.TrailRenderer.createBaseMaterial();var t=new THREE.TextureLoader;t.load("../assets/sparkle4.jpg",function(t){t.wrapS=THREE.RepeatWrapping,t.wrapT=THREE.RepeatWrapping,texturedTrailMaterial=THREE.TrailRenderer.createTexturedMaterial(),texturedTrailMaterial.uniforms.texture.value=t,i(),e&&e()});const i=()=>{trailHeadGeometry=circlePoints,trailMaterial=baseTrailMaterial,initializeTrail()}};const initializeTrail=()=>{trail.initialize(trailMaterial,Math.floor(trailOptions.trailLength),trailOptions.dragTexture?1:0,0,trailHeadGeometry,trailTarget),updateTrailColors(),updateTrailTextureTileSize(),trailMaterial.depthWrite=trailOptions.depthWrite,trail.activate()},updateTrailTextureTileSize=()=>{trailMaterial.uniforms.textureTileFactor.value.set(trailOptions.textureTileFactorS,trailOptions.textureTileFactorT)},updateTrailColors=()=>{trailMaterial.uniforms.headColor.value.set(trailOptions.headRed,trailOptions.headGreen,trailOptions.headBlue,trailOptions.headAlpha),trailMaterial.uniforms.tailColor.value.set(trailOptions.tailRed,trailOptions.tailGreen,trailOptions.tailBlue,trailOptions.tailAlpha)};export const draw3DHand=()=>{const e=new THREE.BoxGeometry(7,7,7),t=new THREE.MeshPhongMaterial({transparent:!0,opacity:0}),i=new THREE.Mesh(e,t);return i.position.z=0,i};export const animate=()=>{frameLoop=requestAnimationFrame(animate);var e=performance.now();if(trailTarget&&updateTrailTarget(e),fruitsObjects&&fruitsObjects.map(e=>{e.rotation.x+=.1,e.rotation.y+=.1,"up"===e.direction&&(e.position.y+=e.speed),e.position.y>e.thresholdBottomY&&!e.soundPlayed&&"up"===e.direction&&("bomb"===e.name?bombSlicedSound.play():newFruitSound.play(),e.soundPlayed=!0),e.position.y>e.thresholdTopY&&(e.direction="down"),"down"===e.direction&&(e.position.y-=e.speed),e.position.y<e.thresholdBottomY&&"down"===e.direction&&(scene.remove(e),fruitsObjects.splice(e.index,1),"bomb"!==e.name&&losePoint(),!gameOver&&generateFruits(1))}),hand){let e=animateHandTrail(hand,camera,fruitsObjects);e&&(score+=1,scoreDivContent.innerHTML=score,fruitSliced.play())}render()};const updateTrailTarget=function(){var e=new THREE.Matrix4,t=new THREE.Matrix4;return function(i){i-lastTrailUpdateTime>10?(trail.advance(),lastTrailUpdateTime=i):trail.updateHead(),e.identity(),t.identity()}}(),animateHandTrail=(e,t,i)=>{const r=new THREE.Vector3;r.x=(window.innerWidth-e.coordinates.x)/window.innerWidth*2-1,r.y=-e.coordinates.y/window.innerHeight*2+1,r.z=0,r.unproject(t);const a=t.position,o=r.sub(a).normalize(),n=-a.z/o.z,s=a.clone().add(o.multiplyScalar(n));e.mesh.position.copy(s),e.mesh.position.z=0,trailTarget.position.set(r.x,r.y,150);let l=e.mesh.geometry;for(var d=e.mesh.position.clone(),c=0;c<l.vertices.length;c++){var m=l.vertices[c].clone(),p=m.applyMatrix4(e.mesh.matrix),u=p.sub(e.mesh.position),T=new THREE.Raycaster(d,u.clone().normalize()),h=T.intersectObjects(i);if(h.length>0&&h[0].distance<200&&!1===h[0].object.hit)return h[0].object.hit=!0,"bomb"===h[0].object.name&&endGame(),scene.remove(h[0].object),i.splice(h[0].object.index,1),!gameOver&&generateFruits(1),!0}return!1};export const resetCamera=()=>{camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),camera.position.set(0,0,cameraZPosition),camera.lookAt(scene.position),renderer.setSize(window.innerWidth,window.innerHeight)};